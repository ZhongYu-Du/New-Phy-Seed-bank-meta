---
title: "Alpine indices"
author: "Eduardo Fern√°ndez Pascual"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE, echo = FALSE, warning = FALSE}
library(tidyverse); library(here); library(FactoMineR); library(cowplot)
library(ggthemes); library(ggrepel); library(flextable); library(ggpubr)

pcaEFP <- function(df, id = 1, header = NULL)
{
  z <- list()
  z$pca <- PCA(df[, -id], scale.unit = TRUE, graph = FALSE)
  if(is.null(header)) z$inds <- data.frame(Plot = df[, id], z$pca$ind$coord[, 1:2])
  if(! is.null(header)) z$inds <- merge(header, data.frame(Plot = df[, id], z$pca$ind$coord[, 1:2]))
  z$vars <- rownames_to_column(data.frame(z$pca$var$coord[, 1:2]), var = "Variable")
  z$vars$Variable <- gsub(".", " ", z$vars$Variable, fixed = TRUE)
  z$contrib <- rownames_to_column(data.frame(z$pca$var$contrib[, 1:2]), var = "Variable")
  z$contrib$Variable <- gsub(".", " ", z$contrib$Variable, fixed = TRUE)
  class(z) <- "mvEFP"
  z
}

summary.mvEFP <- function(pca)
{
  z <- data.frame(pca$pca$var$contrib[, 1:2], pca$pca$var$cor[, 1:2])
  is.num <- sapply(z, is.numeric)
  z[is.num] <- lapply(z[is.num], round, 2)
  colnames(z) <- c("cont.Dim.1", "cont.Dim.2", "corr.Dim.1", "corr.Dim.2")
  z
}

read.csv(here("results", "database", "germination.csv")) %>%
  filter(! is.na(GRS)) %>% # Remove cases without indices
  filter(GRP >= 90) %>% # At least 50% germination
  filter_all(all_vars(!is.infinite(.))) %>% # Remove infinites
  merge(read.csv(here("results", "database", "traits.csv")), by = "TPLName") %>% # Merge with spp traits
  select(TPLName, Region,
         Alpine, Life.form, Lifespan, Seed.mass, Dormancy, Embryo,
         Scarification, GA3, Stratification, Light, Alternating, Temperature,
         GRP:VGT) ->
  indi

indi %>%
  pcaEFP(id = c(1:14)) -> pca

pca$inds %>% 
  filter(Dim.2 < 10) %>% # Outlier
  ggplot(aes(x = Dim.1, y = Dim.2)) +
  labs(title = "Region") +
  theme_wsj() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(aes(color = Plot.Region), size = 3, show.legend = T, alpha = 0.6, shape = 15) +
  theme(legend.position = "top", legend.title = element_blank(),
        legend.text = element_text(size = 7.5),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm"),
        plot.margin = unit(x = c(0, 0, 0, 0), units = "cm"),
        text = element_text(size = 8)) +
  scale_x_continuous(name = paste("Axis 1 (", round(pca$pca$eig[1, 2], 0),
                                  "% variance explained)", sep = "")) + 
  scale_y_continuous(name = paste("Axis 2 (", round(pca$pca$eig[2, 2], 0), 
                                  "% variance explained)", sep = "")) +
  geom_label_repel(data = pca$vars, aes(x = 4*Dim.1, y = 4*Dim.2, label = Variable), 
                  alpha = 0.8, size = 2.5) +
  geom_segment(data = pca$vars, aes(x = 0, y = 0, xend = 4*Dim.1, yend = 4*Dim.2)) -> p1

pca$inds %>% 
  filter(Dim.2 < 10) %>% # Outlier
  ggplot(aes(x = Dim.1, y = Dim.2)) +
  labs(title = "Alpine") +
  theme_wsj() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(aes(color = Plot.Alpine), size = 3, show.legend = T, alpha = 0.6, shape = 15) +
  theme(legend.position = "top", legend.title = element_blank(),
        legend.text = element_text(size = 7.5),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm"),
        plot.margin = unit(x = c(0, 0, 0, 0), units = "cm"),
        text = element_text(size = 8)) +
  scale_x_continuous(name = paste("Axis 1 (", round(pca$pca$eig[1, 2], 0),
                                  "% variance explained)", sep = "")) + 
  scale_y_continuous(name = paste("Axis 2 (", round(pca$pca$eig[2, 2], 0), 
                                  "% variance explained)", sep = "")) +
  geom_label_repel(data = pca$vars, aes(x = 4*Dim.1, y = 4*Dim.2, label = Variable), 
                   alpha = 0.8, size = 2.5) +
  geom_segment(data = pca$vars, aes(x = 0, y = 0, xend = 4*Dim.1, yend = 4*Dim.2)) -> p2

pca$inds %>% 
  filter(Dim.2 < 10) %>% # Outlier
  ggplot(aes(x = Dim.1, y = Dim.2)) +
  labs(title = "Germ. temperature") +
  theme_wsj() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(aes(color = Plot.Temperature), size = 3, show.legend = T, alpha = 0.6, shape = 15) +
  theme(legend.position = "top", legend.title = element_blank(),
        legend.text = element_text(size = 7.5),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm"),
        plot.margin = unit(x = c(0, 0, 0, 0), units = "cm"),
        text = element_text(size = 8)) +
  scale_x_continuous(name = paste("Axis 1 (", round(pca$pca$eig[1, 2], 0),
                                  "% variance explained)", sep = "")) + 
  scale_y_continuous(name = paste("Axis 2 (", round(pca$pca$eig[2, 2], 0), 
                                  "% variance explained)", sep = "")) +
  geom_label_repel(data = pca$vars, aes(x = 4*Dim.1, y = 4*Dim.2, label = Variable), 
                   alpha = 0.8, size = 2.5) +
  geom_segment(data = pca$vars, aes(x = 0, y = 0, xend = 4*Dim.1, yend = 4*Dim.2)) -> p3

pca$inds %>% 
  filter(Dim.2 < 10) %>% # Outlier
  ggplot(aes(x = Dim.1, y = Dim.2)) +
  labs(title = "Life form") +
  theme_wsj() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(aes(color = Plot.Life.form), size = 3, show.legend = T, alpha = 0.6, shape = 15) +
  theme(legend.position = "top", legend.title = element_blank(),
        legend.text = element_text(size = 7.5),
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "cm"),
        plot.margin = unit(x = c(0, 0, 0, 0), units = "cm"),
        text = element_text(size = 8)) +
  scale_x_continuous(name = paste("Axis 1 (", round(pca$pca$eig[1, 2], 0),
                                  "% variance explained)", sep = "")) + 
  scale_y_continuous(name = paste("Axis 2 (", round(pca$pca$eig[2, 2], 0), 
                                  "% variance explained)", sep = "")) +
  geom_label_repel(data = pca$vars, aes(x = 4*Dim.1, y = 4*Dim.2, label = Variable), 
                   alpha = 0.8, size = 2.5) +
  geom_segment(data = pca$vars, aes(x = 0, y = 0, xend = 4*Dim.1, yend = 4*Dim.2)) -> p4
```

# Explanation of the indices by S Rosbakh

Here come some explanations about the indices. 

The abbreviations are read as follows:

* GRS - number of germination seeds
* GRP - germination percentage (from 0 to 100%)
* MGT - mean germination time (time units)
* MGR - mean germination rate (time units)
* GSP - germination speed (%)
* UNC - uncertanty index (bits)
* SYN - syncronization index (from 0 to 1)
* VGT - germination variance
* SDG - germination standard deviation
* CVG - coefficient of variation

GRS and GRP are easy and you have already these data. Basically, MGT, MGR and GSP describe seed germination speed; these three indices are tightly positively (r>0.8) correlated with each other. I would do descriptive statistics with all of them first to see how they differ in your data set. These three indices are strongly temperature-dependent - in my data the relationship is linear and almost perfect (r2=0.8). Thus, you might consider analysing germination speed for one most optimal temperature of germination (around 20 C).

UNC and SYN characterise germination synchrony and tightly positively correlated with each other. I personally prefer the SYN, because it is more intuitive, but I would try both of them.

I have not had time to explore VGT, SDG and CVG, but I think they are not very informative (though I might be wrong). You might consider exploring them as well.

IMPORTANT: I have noticed that calculation of all indices for the cases with a very low number of germinated seeds (GRS) result in spurious results. For example, if only one single seed germinated, its germination timing (e.g. day 7 or day 14) considerably influenced seed germination time and synchrony. May be it makes sense from statistical point of you, but as an ecologist I would not trust them. Thus, I recommend to use only the cases with a comparatively high proportion of seeds germinated (e.g. GRP >30%). Furthermore, in some cases calculations resulted in zero or infinite values and NAs, because of no germination at all or very low number of germinated seeds.

I used the GerminaR package for calculations; more details on the indices are in the paper (https://www.researchgate.net/publication/331073880_GerminaR_An_R_package_for_germination_analysis_with_the_interactive_web_application_GerminaQuant_for_R).

# A note by Sergey on scoring length and intensity

I took a closer look at the experiment duration and scoring intensity of the data I processed and, came to the conclusion that the majority of the germination experiments were conducted in a more or less the same way. The only problematic data set are experiments from Anissa, in which seeds were incubated for several months. 

Source	Duration	Scoring intensity
Andrea Mondoni	42 days	6 times
Bu	40-60 days	40-60 times
Rosbakh_Alps	42 days	8 times
Rosbakh_Caucaus	42 days	8 times
Anissa	49-140	12-22 times
Eduardo	28 days	4 times
Susanne Venn	40-60 days	11-21 times
Veronica	24-48 days	9-17 times

I re-calculated the indices for shorter timer series (ca. 60 days; orange tabs; attached) and hope that the PCA will look better now. BTW, Eduardo, did you scale the data before the analysis? The indices scales have very different scale lengths that should be accounted for.

One further improvement would be to reduce the time series in Anissa's, Venn's and Bu's data to 40 days, to make the differences even smaller, but it would require additional data re-formatting.

# Number of records with >90% germination and germination indices, by region.

```{r table1, echo = FALSE}
indi %>% group_by(Region) %>% tally
```

# Number of records with >90% germination and germination indices, by alpine strict vs. generalist.

```{r table2, echo = FALSE}
indi %>% group_by(Alpine) %>% tally
```

# PCA of the indices (see figures below)

```{r table3, echo = FALSE}
summary(pca)
```

# Some conclusions (see figures below)

* MGR and SYN seem to capture the most variance, and are the most intuitive
* Main differences seem to be among regions, BUT the Australian (highest mean germination time) were also the longest running experiments, I bet this is an artifact of experiment lenght (please kill me)
* Indices are not normal


```{r fig1, echo = FALSE, fig.cap = "PCA of the germination indices colored by Region"}
p1
```

```{r fig2, echo = FALSE, fig.cap = "PCA of the germination indices colored by Alpine"}
p2
```

```{r fig3, echo = FALSE, fig.cap = "PCA of the germination indices colored by germination temperature"}
p3
```

```{r fig4, echo = FALSE, fig.cap = "PCA of the germination indices colored by life form"}
p4
```

```{r fig5, echo = FALSE, fig.cap = "Normality of the indices"}
plot_grid(
# Density plot
ggdensity(indi$MGR, fill = "lightgray") + 
  theme_wsj() +
  labs(title = "MGR density plot"),
# QQ plot
ggqqplot(indi$MGR) +
    theme_wsj() +
  labs(title = "QQplot"),
# Density plot
ggdensity(indi$SYN, fill = "lightgray") + 
    theme_wsj() +
  labs(title = "SYN density plot"),
# QQ plot
ggqqplot(indi$SYN) +
    theme_wsj() +
  labs(title = "QQ plot"))
```